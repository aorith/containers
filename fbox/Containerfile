# ARGs must be redeclared between FROM statements
ARG FEDORA_MAJOR_VERSION
FROM registry.fedoraproject.org/fedora:${FEDORA_MAJOR_VERSION}

ARG FEDORA_MAJOR_VERSION
ARG CURRENT_VERSION_REF

LABEL "io.containers.autoupdate"="registry"

COPY --from=ghcr.io/aorith/nvim-full:latest /build/neovim-flake-closure /nix/store
COPY --from=ghcr.io/aorith/nvim-full:latest /build/result/bin/nvim /usr/local/bin/nvim

# COPY --from=ghcr.io/aorith/nvim-deps:latest /build/neovim-with-deps-closure /nix/store
# COPY --from=ghcr.io/aorith/nvim-deps:latest /build/dotfiles/topics/nvim/result/bin/* /usr/local/bin/

RUN dnf install -y \
    "https://mirrors.rpmfusion.org/free/fedora/rpmfusion-free-release-${FEDORA_MAJOR_VERSION}.noarch.rpm" \
    "https://mirrors.rpmfusion.org/nonfree/fedora/rpmfusion-nonfree-release-${FEDORA_MAJOR_VERSION}.noarch.rpm" \
    && ln -s /usr/bin/distrobox-host-exec /usr/local/bin/rpm-ostree \
    && ln -s /usr/bin/distrobox-host-exec /usr/local/bin/podman \
    && ln -s /usr/bin/distrobox-host-exec /usr/local/bin/docker \
    && ln -s /usr/bin/distrobox-host-exec /usr/local/bin/flatpak \
    && ln -s /usr/bin/distrobox-host-exec /usr/local/bin/wl-copy \
    && ln -s /usr/bin/distrobox-host-exec /usr/local/bin/wl-paste \
    && ln -s /usr/bin/distrobox-host-exec /usr/local/bin/xclip

COPY ./dnf-packages /tmp/
RUN printf "\nfastestmirror=True\nmax_parallel_downloads=10\n" >> "/etc/dnf/dnf.conf" \
    && dnf update -y --refresh \
    && dnf install -y $(grep -Ev '^#' /tmp/dnf-packages) "@Development Tools" \
    && curl -L -o /usr/local/bin/yq "https://github.com/mikefarah/yq/releases/download/v4.34.1/yq_linux_amd64" \
    && chmod +x /usr/local/bin/yq \
    && dnf copr enable -y atim/starship && dnf install -y starship \
    && dnf clean all \
    && rm -rf /tmp/* \
    && echo "${FEDORA_MAJOR_VERSION}-${CURRENT_VERSION_REF}" > /CURRENT_VERSION.txt \
    echo "$(date +'%Y-%m-%d %H:%M:%S')" > /BUILD_DATE.txt
